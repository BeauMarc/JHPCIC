<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>保费支付</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="global.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="header">
    保费支付
    <span id="statusTag" class="status-tag status-pending">待支付</span>
  </div>
  <div class="content-card">
    <div id="info" class="info-block">正在加载订单信息...</div>
    <div class="qr-wrap">
      <div class="qr-box">
        <div>支付宝扫码支付<span class="badge">推荐</span></div>
        <div id="alipayQr"></div>
        <p class="small">使用支付宝扫一扫完成支付。</p>
      </div>
      <div class="qr-box" id="wechatBox" style="display:none;">
        <div>微信收款码</div>
        <img id="wechatImg" src="" alt="微信收款二维码" />
        <p class="small">使用微信扫码支付（如金额与本页不一致，请立即终止支付）。</p>
      </div>
    </div>
    <p class="notice">支付完成后，请点击下方“我已完成支付”，系统会更新订单状态。</p>
    <div class="btn-row">
      <button class="btn-secondary" id="backBtn">暂不支付</button>
      <button class="btn-primary" id="paidBtn">我已完成支付</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://pefccznphgacswztqzrp.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZmNjem5waGdhY3N3enRxenJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTQwMTgsImV4cCI6MjA3OTczMDAxOH0.nz5gdOBpGzWIRm8qU49O0JFCyMc3csmHwhNA_YkpixY";
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const params = new URLSearchParams(window.location.search);
  const orderId = params.get("id");

  const infoEl = document.getElementById("info");
  const statusTag = document.getElementById("statusTag");
  const alipayQrEl = document.getElementById("alipayQr");
  const wechatBox = document.getElementById("wechatBox");
  const wechatImg = document.getElementById("wechatImg");
  const backBtn = document.getElementById("backBtn");
  const paidBtn = document.getElementById("paidBtn");

  let orderData = null;

  function setStatus(status) {
    if (status === "paid") {
      statusTag.textContent = "已支付";
      statusTag.className = "status-tag status-paid";
    } else if (status === "signed") {
      statusTag.textContent = "已签名";
      statusTag.className = "status-tag status-signed";
    } else {
      statusTag.textContent = "待支付";
      statusTag.className = "status-tag status-pending";
    }
  }

  async function loadOrder() {
    if (!orderId) {
      infoEl.textContent = "缺少订单ID";
      return;
    }
    const { data, error } = await supabaseClient
      .from("insurance_orders")
      .select("*")
      .eq("id", orderId)
      .maybeSingle();
    if (error || !data) {
      infoEl.textContent = "未找到订单，请联系服务人员。";
      console.error(error);
      return;
    }
    orderData = data;
    setStatus(data.status);

    const text =
      "订单号：" + data.id + "\n" +
      "车牌号：" + data.plate + "\n" +
      "应付保费：" + (data.fee != null ? data.fee.toFixed(2) : "") + " 元\n" +
      "保险期限：" + (data.period || "（见投保单）");
    infoEl.textContent = text;

    const alipayUrl = data.alipay_qr_url;
    if (alipayUrl) {
      new QRCode(alipayQrEl, {
        text: alipayUrl,
        width: 200,
        height: 200
      });
    } else {
      alipayQrEl.innerHTML = "<p class='small'>未配置支付宝支付链接，请联系服务人员。</p>";
    }

    if (data.wechat_qr_url) {
      wechatBox.style.display = "block";
      wechatImg.src = data.wechat_qr_url;
    } else {
      wechatBox.style.display = "none";
    }
  }

  backBtn.addEventListener("click", () => {
    if (orderId) {
      window.location.href = "verify.html?id=" + encodeURIComponent(orderId);
    } else {
      history.back();
    }
  });

  paidBtn.addEventListener("click", async () => {
    if (!orderId) return;
    paidBtn.disabled = true;
    try {
      const { error } = await supabaseClient
        .from("insurance_orders")
        .update({ status: "paid" })
        .eq("id", orderId);
      if (error) {
        alert("更新支付状态失败，请重试或联系服务人员。");
        paidBtn.disabled = false;
        return;
      }
      setStatus("paid");
      alert("感谢您的支付，订单状态已更新为“已支付”。");
    } catch (e) {
      console.error(e);
      alert("更新支付状态失败，请重试或联系服务人员。");
      paidBtn.disabled = false;
    }
  });

  loadOrder();
</script>
</body>
</html>
